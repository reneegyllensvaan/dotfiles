#!/bin/sh


stretch_notification () {
  while true; do
    osascript -e 'display notification "Stretch!" with title "syncer"';
    sleep 600;
    osascript -e 'display notification "Stretch!" with title "syncer"';
    sleep 600;
    osascript -e 'display notification "Stretch!" with title "syncer"';
    sleep 600;
    osascript -e 'display notification "Move around a bit!" with title "syncer"';
    sleep 600;
  done
}

fetch_email () {
  while true; do
    # Purge everything in trash from other tags
    notmuch new
    notmuch tag --remove-all +trash tag:trash and tag:strict-delete
    notmuch tag +trash -killed tag:killed

    # Manually apply some tagging rules gmail doesn't
    # (gmail doesn't seem to allow both moving to a label and to trash in inbox
    # rules without clearing labels)
    notmuch tag -important tag:github
    notmuch tag +trash tag:github and not tag:unread and not tag:trash
    notmuch tag +trash tag:asana and not tag:unread and not tag:trash

    # Do gmailieer sync (for notmuch/neomutt)
    [ "$USER_WORK_EMAIL" ] && (cd ~/email/work && gmi sync)
    [ "$USER_HOME_EMAIL" ] && (cd ~/email/home && gmi sync)
    # Get amount of new email
    notmuch tag -unnotified tag:github or tag:trello
    new_mail=`notmuch search tag:unnotified | wc -l | awk '{print $1}'`
    # if [ $new_mail != '0' ]; then
    #   [ $OPERATING_SYSTEM = 'osx' ] && \
    #     osascript -e 'display notification "'"$new_messages"'new messages" with title "notmuch"'
    # fi
    notmuch tag -unnotified tag:unnotified
    sleep $EMAIL_SYNC_INTERVAL;
  done
}

#fetch_email & stretch_notification
fetch_email
